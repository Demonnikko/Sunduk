<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no">
<title>Сундук удачи — ШОУ «Секрет»</title>
<meta name="robots" content="noindex,nofollow">
<meta name="theme-color" content="#0a0a0f">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<!-- Премиальные шрифты -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&family=Cormorant+Garamond:wght@600;700&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#fffefc; --muted:#cfd2dc;
  --bg1:#0b0c18; --bg2:#12142c;
  --brandA1:#ffeaa5; --brandA2:#ffc861; --brandA3:#d99a2a;

  /* Металлы для купонов */
  --iron1:#e8ebf2; --iron2:#aab2c3; --iron3:#6b7386;         /* железо (10%) */
  --bronze1:#ffe2bf; --bronze2:#d79551; --bronze3:#7b491f;   /* бронза (15%) */
  --silver1:#f6f8ff; --silver2:#cdd5e8; --silver3:#8e97ab;   /* серебро (20%) */
  --goldA:#fff3a8; --goldB:#ffd062; --goldC:#e09f2f;         /* золото (50%) */
  --plat1:#efeaff; --plat2:#d7cffd; --plat3:#a197ff;         /* платина (free) */

  --ff-head:"Cormorant Garamond", serif;
  --ff:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  --shadow:0 40px 120px rgba(0,0,0,.6);
  --focus:#89c2ff;
}
*{box-sizing:border-box;margin:0}
html,body{height:100%}
body{
  background:
    radial-gradient(110% 100% at 50% -10%, var(--bg2) 0%, var(--bg1) 55%, #070711 100%),
    radial-gradient(80% 70% at 50% 120%, rgba(255,200,120,.06), transparent 70%);
  color:var(--ink);font:500 16px/1.6 var(--ff);-webkit-font-smoothing:antialiased;overflow-x:hidden
}
.bg{position:fixed;inset:-10% -10% 0 -10%;z-index:-3;pointer-events:none}
.bg::before,.bg::after{content:"";position:absolute;inset:0;filter:blur(42px);mix-blend-mode:screen}
.bg::before{background:radial-gradient(40% 35% at 30% 8%, color-mix(in oklab, var(--brandA2) 40%, transparent), transparent 55%),radial-gradient(40% 35% at 70% 6%, color-mix(in oklab, var(--brandA3) 30%, transparent), transparent 60%)}
.bg::after{animation:rot 20s linear infinite;background:conic-gradient(from 0deg, color-mix(in oklab, var(--brandA1) 30%, transparent),transparent 25%, color-mix(in oklab, var(--brandA2) 28%, transparent) 45%,transparent 60%, color-mix(in oklab, var(--brandA3) 30%, transparent) 80%, transparent)}
@keyframes rot{to{transform:rotate(360deg)}}
#sparkle{position:fixed;inset:0;z-index:-2;pointer-events:none;opacity:.9}

/* Компоновка */
.stage{min-height:100svh;display:grid;place-items:center;padding:14px}
.wrap{width:min(1140px,96vw);display:grid;gap:14px}
.brand{display:grid;place-items:center;user-select:none}
.brand h2{font:700 clamp(16px,4.6vw,22px)/1 var(--ff);letter-spacing:.08em;color:#e9e9f2;opacity:.9}
.h1{font:700 clamp(28px,6.5vw,52px)/1.02 var(--ff-head);text-align:center;color:#fff;text-shadow:0 6px 0 rgba(0,0,0,.55),0 0 18px color-mix(in oklab, var(--brandA1) 24%, transparent)}
.sub{font:600 clamp(13px,3.6vw,17px)/1.5 var(--ff-head);text-align:center;color:var(--muted)}

.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:18px;align-items:start}
@media (max-width:980px){.grid{grid-template-columns:1fr;gap:12px}}

.panel{background:linear-gradient(180deg,#17183a,#11122a);border:4px solid #0b0c1d;border-radius:22px;padding:12px;box-shadow:var(--shadow)}
@media (max-width:980px){.panel{padding:10px;border-radius:18px}}

.stagebox{display:grid;place-items:center}
.chest-wrap{position:relative;width:min(760px,98%);height:clamp(280px,48vw,420px);perspective:1300px}
@media (max-width:560px){.chest-wrap{height:clamp(260px,58vw,360px)}}
.aura{position:absolute;inset:-5% -6%;z-index:-1;border-radius:40px;filter:blur(22px);background:radial-gradient(80% 60% at 50% 60%, color-mix(in oklab, var(--brandA1) 35%, transparent), rgba(0,0,0,0));opacity:.45;animation:breathe 3.2s ease-in-out infinite}
@keyframes breathe{0%,100%{opacity:.35;transform:scale(1)}50%{opacity:.7;transform:scale(1.04)}}
.chest{position:absolute;inset:0;margin:auto;transform-style:preserve-3d;filter:drop-shadow(0 26px 50px rgba(0,0,0,.55))}
.chest__base,.chest__lid{position:absolute;left:0;right:0;margin:auto;width:100%;border-radius:22px;overflow:visible}
.cartoon{background:linear-gradient(180deg, rgba(255,255,255,.22), transparent 28%),linear-gradient(180deg, #c2763b 0%, #8c4a22 58%, #572a12 100%);border:6px solid #2b1408; box-shadow:inset 0 5px 0 rgba(255,255,255,.45), inset 0 -6px 0 rgba(0,0,0,.4)}
.chest__base{bottom:0;height:66%}
.chest__lid{top:0;height:54%;transform-origin:50% 100%;transform:rotateX(0deg)}
.chest.open .chest__lid{animation:lidOpen .72s cubic-bezier(.2,1,.22,1) forwards}
@keyframes lidOpen{0%{transform:rotateX(0deg)}70%{transform:rotateX(-78deg)}86%{transform:rotateX(-64deg)}100%{transform:rotateX(-72deg)}}
.band{position:absolute;left:18px;right:18px;height:18px;border-radius:12px;border:5px solid #3a2208;background:linear-gradient(180deg,var(--brandA1),var(--brandA2) 60%, var(--brandA3));box-shadow:inset 0 5px 0 rgba(255,255,255,.6), inset 0 -5px 0 rgba(0,0,0,.45), 0 8px 0 #0004}
.band.t{top:14px}.band.m{top:50%;transform:translateY(-50%)}.band.b{bottom:14px}
.lock{position:absolute;left:50%;transform:translateX(-50%);top:calc(54% - 14px);width:90px;height:112px;border-radius:20px;background:linear-gradient(180deg,var(--brandA2),var(--brandA3));border:6px solid #3a2208;box-shadow:inset 0 5px 0 rgba(255,255,255,.5), inset 0 -6px 0 rgba(0,0,0,.45), 0 10px 0 #0004}
.lock::before{content:"";position:absolute;left:50%;transform:translateX(-50%);top:-44px;width:72px;height:44px;border-radius:24px 24px 0 0;border:7px solid #6c4a18;border-bottom:0;background:linear-gradient(180deg,var(--brandA1),var(--brandA3))}
.keyhole{position:absolute;left:50%;top:34px;transform:translate(-50%,0);width:18px;height:22px;border-radius:12px;background:#000;border:5px solid #2a1806;box-shadow:0 0 0 6px rgba(0,0,0,.25), 0 0 14px rgba(255,210,120,.0)}
.light-oval{position:absolute;inset:auto 0 9%;margin:auto;width:86%;height:22px;background:radial-gradient(60% 120% at 50% 100%, color-mix(in oklab, var(--brandA1) 70%, transparent), color-mix(in oklab, var(--brandA1) 22%, transparent) 62%, transparent 72%);filter:blur(16px);opacity:0;transition:opacity .35s}
.chest.open + .light-oval{opacity:1}

/* Ключи */
.keys{display:grid;gap:12px;margin-top:10px;justify-items:center}
@media (min-width:981px){.keys{grid-template-columns:repeat(12,minmax(40px,1fr))}}
@media (max-width:980px){.keys{grid-template-columns:repeat(8,minmax(44px,1fr))}}
.key{appearance:none;cursor:pointer;background:transparent;border:0;padding:0;width:54px;height:54px;position:relative;transition:transform .12s;outline:0;transform:translate(var(--tx,0),var(--ty,0)) rotate(var(--rot,0deg))}
@media (max-width:560px){.key{width:48px;height:48px}}
.key svg{width:100%;height:100%;display:block;filter:drop-shadow(0 3px 6px rgba(0,0,0,.5))}
.key:hover{transform:translate(var(--tx,0),var(--ty,0)) translateY(-6px) rotate(calc(var(--rot,0deg) - 4deg)) scale(1.06)}
.key:active{transform:translate(var(--tx,0),var(--ty,0)) translateY(-2px) rotate(calc(var(--rot,0deg) - 1deg)) scale(1.02)}
.keys.disabled{opacity:.45;pointer-events:none}
.fly{position:fixed;z-index:60;width:54px;height:54px;pointer-events:none;filter:drop-shadow(0 14px 20px rgba(0,0,0,.6));transition:transform .52s cubic-bezier(.2,1.1,.2,1.02)}
.key[data-rare="1"]::after{content:"★";position:absolute;right:-4px;top:-6px;background:var(--brandA3);color:#fff;font:900 12px var(--ff);border:3px solid #2b1408;border-radius:10px;padding:1px 3px;transform:rotate(8deg)}

/* Правая колонка */
.copy h2{font:700 clamp(20px,5.2vw,34px)/1.05 var(--ff-head);color:#fff;text-align:center;margin-bottom:4px}
.copy p{color:var(--muted);text-align:center;margin-bottom:8px}
.badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.badge{border-radius:14px;padding:7px 10px;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.2));border:4px solid rgba(255,255,255,.14);font:700 13px var(--ff);color:#e6e6f1}
.sound{margin-top:6px;display:flex;gap:10px;align-items:center;justify-content:center}
.switch{position:relative;width:56px;height:30px;border-radius:999px;background:#2b2b3f;border:3px solid #1a1a28;cursor:pointer}
.switch i{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;transition:left .18s}
.switch.on{background:var(--brandA1);border-color:var(--brandA3)}
.switch.on i{left:28px}

/* Кнопки */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:16px 22px;border-radius:16px;min-height:48px;line-height:1;font:800 18px var(--ff-head);letter-spacing:.02em;text-align:center;color:#1a1206;cursor:pointer;user-select:none;background:linear-gradient(180deg,var(--brandA1),var(--brandA2) 55%, var(--brandA3));border:6px solid #2b1a08;box-shadow:inset 0 5px 0 rgba(255,255,255,.6), inset 0 -5px 0 rgba(0,0,0,.3), 0 12px 0 #0004;transition:transform .06s, filter .2s}
.btn:active{transform:translateY(1px)}
.btn-ghost{color:#fff;background:linear-gradient(180deg,#221f44,#171736);border:4px solid rgba(255,255,255,.18);box-shadow:inset 0 4px 0 rgba(255,255,255,.2), inset 0 -4px 0 rgba(0,0,0,.35)}
.btn:focus-visible{outline:3px solid var(--focus);outline-offset:3px;border-radius:18px}

/* Модалка */
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:80}
.modal.open{display:grid}
.modal__bg{position:absolute;inset:0;background:rgba(10,10,18,.85);backdrop-filter:blur(6px)}
.modal__panel{position:relative;z-index:1;width:min(96vw,720px);max-height:92svh;overflow:auto;background:linear-gradient(180deg,#191b46,#131433);border:6px solid rgba(255,255,255,.12);border-radius:22px;box-shadow:0 40px 90px rgba(0,0,0,.8), inset 0 5px 0 rgba(255,255,255,.08);padding:14px 12px 18px;text-align:center;transform:scale(.96);opacity:0;transition:transform .35s cubic-bezier(.2,.9,.2,1.1),opacity .3s}
.modal.open .modal__panel{transform:scale(1);opacity:1}
.modal__title{font:700 clamp(22px,5.6vw,34px)/1.08 var(--ff-head);color:#fff;margin-bottom:4px}
.modal__note{color:#d6d6dc;margin-bottom:10px;font:600 clamp(13px,3.6vw,16px) var(--ff)}

/* Таймер 3 минуты */
.timer{display:grid;gap:6px;align-items:center;justify-items:center;margin:6px auto 10px}
.timer .value{font:800 clamp(14px,4vw,16px) var(--ff-head);color:#fff;padding:6px 10px;border-radius:14px;border:4px solid rgba(255,255,255,.14);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.2))}

/* Купон (premium ticket) */
.ticket{position:relative;margin:10px auto;width:min(640px,92%);aspect-ratio:16/7;border-radius:20px;display:grid;place-items:center;overflow:hidden;color:#2b1706;text-align:center;border:8px solid #2b1408;box-shadow:inset 0 5px 0 rgba(255,255,255,.5), inset 0 -5px 0 rgba(0,0,0,.35), 0 26px 66px rgba(0,0,0,.55);transform:translateY(10px) scale(.96);opacity:0}
.ticket.pop{animation:ticketIn .42s cubic-bezier(.2,.95,.2,1.15) forwards}
@keyframes ticketIn{50%{transform:translateY(-4px) scale(1.03)}100%{transform:translateY(0) scale(1);opacity:1}}
.ticket::before,.ticket::after{content:"";position:absolute;top:50%;width:26px;height:26px;border-radius:50%;background:#131323;border:4px solid rgba(255,255,255,.12);transform:translateY(-50%)}.ticket::before{left:-13px}.ticket::after{right:-13px}
.ticket .shine{position:absolute;inset:-60% -80% auto -80%;height:170%;background:linear-gradient(100deg,transparent 45%,rgba(255,255,255,.7) 50%,transparent 55%);transform:translateX(-100%) rotate(12deg);animation:shine 2.4s linear infinite}
@keyframes shine{to{transform:translateX(130%) rotate(12deg)}}

/* Макет контента купона */
.ticket .inner{display:grid;gap:4px;width:86%;place-items:center}
.ticket .sup{font:700 clamp(12px,3vw,14px) var(--ff);letter-spacing:.12em;opacity:.9}
.ticket .title{font:700 clamp(22px,5vw,36px)/1.08 var(--ff-head);text-wrap:balance}
.ticket .subtitle{font:700 clamp(14px,3.4vw,18px) var(--ff-head);opacity:.95}
.ticket .meta{font:700 clamp(11px,2.6vw,13px) var(--ff);opacity:.9;text-transform:none}

/* Цвета + контрастный текст */
.ticket.iron{background:linear-gradient(160deg,var(--iron1),var(--iron2) 58%,var(--iron3));color:#1a1f2a}
.ticket.bronze{background:linear-gradient(160deg,var(--bronze1),var(--bronze2) 58%,var(--bronze3));color:#2a1406}
.ticket.silver{background:linear-gradient(160deg,var(--silver1),var(--silver2) 58%,var(--silver3));color:#101522}
.ticket.gold{background:linear-gradient(160deg,var(--goldA),var(--goldB) 58%,var(--goldC));color:#201408}
.ticket.platinum{background:linear-gradient(160deg,var(--plat1),var(--plat2) 58%,var(--plat3));color:#131128}

.action-row{margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.action-row .btn{min-width:240px}

/* Эффекты */
#confetti{position:fixed;inset:0;z-index:90;pointer-events:none;display:none}
.flash{position:fixed;inset:0;background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.95), rgba(255,255,255,0));opacity:0;pointer-events:none;z-index:74;transition:opacity .25s}
.flash.on{opacity:1}

/* Форма (в отдельной модалке) */
.form-modal .modal__panel{width:min(96vw,560px)}
.form-grid{display:grid;gap:10px;width:min(520px,92%);margin:0 auto}
.inp{padding:14px 16px;border-radius:12px;border:3px solid rgba(255,255,255,.18);background:#14163a;color:#fff;outline:none;font:600 16px var(--ff)}
label{font:700 13px var(--ff);text-align:left;opacity:.9;margin-top:2px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:120;background:#0e142a;color:#fff;border:2px solid #3c4a9a;padding:10px 14px;border-radius:12px;font:700 14px var(--ff);display:none}
.toast.show{display:block}

/* Редьюс-мошен */
@media (prefers-reduced-motion: reduce){
  *{animation:none!important;transition:none!important}
  .flash{display:none}
}
</style>
</head>
<body>
<div class="bg"></div>
<canvas id="sparkle"></canvas>
<div id="flash" class="flash"></div>

<main class="stage" aria-live="polite">
  <div class="wrap">
    <div class="brand"><h2>ШОУ • СЕКРЕТ</h2></div>
    <h1 class="h1">Сундук удачи</h1>
    <p class="sub">Выбирай ключ — если замок вспыхнет, сундук откроется и выдаст твой премиальный купон.</p>

    <section class="grid">
      <div class="panel stagebox" id="scene">
        <div class="chest-wrap">
          <div class="aura"></div>
          <div id="chest" class="chest" aria-label="Сундук">
            <div class="chest__lid cartoon"></div>
            <div class="chest__base cartoon"></div>
            <div class="band t"></div><div class="band m"></div><div class="band b"></div>
            <div class="lock">
              <div class="keyhole"></div>
            </div>
          </div>
          <div class="light-oval"></div>
        </div>

        <div class="keys" id="keys" role="grid" aria-label="Поле ключей"></div>
      </div>

      <div class="panel copy">
        <h2>Правила</h2>
        <p>Кликай по ключам. Каждый клик — купон. Нажми «Получить купон», заполни ФИО, Telegram и телефон — заявка упадёт нам, и мы вышлем твой личный QR-код.</p>
        <div class="badges" style="align-items:center">
          <span class="badge" id="keysInfo">Ключей на поле: —</span>
          <span class="badge" id="rareInfo" title="Особые ключи повышают эффект">Особые ключи: есть ★</span>
        </div>
        <div class="sound" aria-live="polite">
          <span>Звук:</span>
          <button id="soundToggle" type="button" class="switch" aria-pressed="true" aria-label="Переключить звук"><i></i></button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Модалка выигрыша -->
<div class="modal" id="winModal" aria-hidden="true" role="dialog">
  <div class="modal__bg" data-close="1"></div>
  <div class="modal__panel" role="document" aria-label="Ваш приз">
    <div class="modal__title" id="prizeTitle">Ваш купон</div>
    <div class="modal__note" id="prizeNote">Поторопитесь: купон нужно активировать в течение <b>3 минут</b>.</div>

    <div class="timer">
      <div class="value">До аннулирования: <span id="countdown">03:00</span></div>
    </div>

    <div id="ticketBox" class="ticket" aria-live="polite">
      <div class="shine"></div>
      <div class="inner">
        <div class="sup" id="ticketSup">ШОУ «Секрет» • Премиальный купон</div>
        <div class="title" id="ticketTitle">Поздравляем — вы выиграли</div>
        <div class="subtitle" id="ticketText">Скидка</div>
        <div class="meta" id="ticketMeta">Предъявите QR‑код на кассе</div>
      </div>
    </div>

    <div class="action-row">
      <button id="getCoupon" class="btn">Получить купон</button>
    </div>
  </div>
</div>

<!-- Модалка формы -->
<div class="modal form-modal" id="formModal" aria-hidden="true" role="dialog">
  <div class="modal__bg" data-close="1"></div>
  <div class="modal__panel" role="document" aria-label="Форма для получения купона">
    <div class="modal__title">Активировать купон</div>
    <div class="modal__note">Заполните данные — мы пришлём ваш уникальный QR‑код в Telegram.</div>
    <form id="couponForm" class="form-grid">
      <div>
        <label for="fio">Фамилия Имя Отчество</label>
        <input id="fio" class="inp" placeholder="Иванов Иван Иванович" required>
      </div>
      <div>
        <label for="username">Username в Telegram (без @)</label>
        <input id="username" class="inp" placeholder="username" required>
      </div>
      <div>
        <label for="phone">Номер телефона</label>
        <input id="phone" class="inp" inputmode="tel" placeholder="+7 999 000 00 00" required>
      </div>
      <button id="sendForm" type="submit" class="btn">Отправить</button>
    </form>
  </div>
</div>

<canvas id="confetti"></canvas>
<div id="toast" class="toast">Спасибо! Скоро вам напишет создатель шоу «Секрет».</div>

<script>
/* === DOM === */
const $=s=>document.querySelector(s);
const keysWrap=$('#keys'), keysInfo=$('#keysInfo');
const chest=$('#chest'), keyhole=chest.querySelector('.keyhole');
const confettiCanvas=document.getElementById('confetti');
const soundToggle=$('#soundToggle');
const winModal=$('#winModal'), formModal=$('#formModal');
const ticketBox = $('#ticketBox'), ticketTitle=$('#ticketTitle'), ticketText=$('#ticketText'), prizeTitle=$('#prizeTitle');
const toast=$('#toast');

/* === Конфиг отправки === */
const API_URL = '/api/send'; // верселевский эндпоинт (см. api/send.js)

/* === Параметры игры === */
const KEY_COUNT_DESKTOP=44, KEY_COUNT_MOBILE=30;
const isMobile = matchMedia('(max-width:560px)').matches;
const confettiCap = isMobile ? 240 : 400;
let SOUND = (localStorage.getItem('sg_sound') ?? '1') === '1';

/* === Призы === */
const PRIZES = [
  { id:'p10', label:'Скидка 10%', class:'iron'     },
  { id:'p15', label:'Скидка 15%', class:'bronze'   },
  { id:'p20', label:'Скидка 20%', class:'silver'   },
  { id:'p50', label:'Скидка 50%', class:'gold'     },
  { id:'free',label:'Бесплатный билет', class:'platinum' }
];
function choosePrize(){
  const weights = [48,24,16,8,4]; // p10..free
  const sum = weights.reduce((s,v)=>s+v,0);
  let r = Math.random()*sum, i=0;
  for(; i<weights.length; i++){ r -= weights[i]; if(r<=0) break; }
  return PRIZES[i] || PRIZES[0];
}

/* === Генерация ключей === */
function keySVG(v=0,a="var(--brandA1)",b="var(--brandA2)"){
  const stroke="#2b1a08", sw=5;
  if(v===1) return `<svg viewBox="0 0 120 64" aria-hidden="true"><defs><linearGradient id="g1" x1="0" y="0" x2="1" y="1"><stop offset="0%" stop-color="${a}"/><stop offset="100%" stop-color="${b}"/></linearGradient></defs><g fill="url(#g1)" stroke="${stroke}" stroke-width="${sw}"><circle cx="26" cy="32" r="18"/><rect x="44" y="29" width="46" height="6" rx="3"/><rect x="90" y="25" width="8" height="14" rx="2"/><rect x="100" y="27" width="10" height="10" rx="2"/></g></svg>`;
  if(v===2) return `<svg viewBox="0 0 120 64" aria-hidden="true"><defs><linearGradient id="g2" x1="0" y="0" x2="1" y="1"><stop offset="0%" stop-color="${a}"/><stop offset="100%" stop-color="${b}"/></linearGradient></defs><g fill="url(#g2)" stroke="${stroke}" stroke-width="${sw}"><rect x="14" y="20" width="28" height="24" rx="12"/><rect x="44" y="29" width="50" height="6" rx="3"/><rect x="94" y="25" width="8" height="14" rx="2"/><rect x="104" y="23" width="10" height="18" rx="2"/></g></svg>`;
  return `<svg viewBox="0 0 120 64" aria-hidden="true"><defs><linearGradient id="g0" x1="0" y="0" x2="1" y="1"><stop offset="0%" stop-color="${a}"/><stop offset="100%" stop-color="${b}"/></linearGradient></defs><g fill="url(#g0)" stroke="${stroke}" stroke-width="${sw}"><circle cx="24" cy="32" r="16"/><rect x="42" y="29" width="52" height="6" rx="3"/><rect x="96" y="25" width="8" height="14" rx="2"/><rect x="106" y="27" width="10" height="10" rx="2"/></g></svg>`;
}
function renderKeys(){
  const mob=matchMedia('(max-width:980px)').matches;
  const N=mob?KEY_COUNT_MOBILE:KEY_COUNT_DESKTOP;
  keysWrap.innerHTML='';
  for(let i=0;i<N;i++){
    const b=document.createElement('button');
    b.className='key'; b.setAttribute('role','gridcell'); b.setAttribute('aria-label','Ключ '+(i+1));
    const v=i%3;
    b.innerHTML=keySVG(v);
    if(i%9===0){ b.dataset.rare='1'; b.title='Особый ключ'; }
    const rot=(Math.random()*10-5).toFixed(1);
    b.style.setProperty('--rot', rot+'deg');
    keysWrap.appendChild(b);
  }
  keysInfo.textContent='Ключей на поле: '+N;
}
renderKeys(); addEventListener('resize',renderKeys);

/* === Аудио минимализм === */
const AC=window.AudioContext||window.webkitAudioContext; let actx;
function ctx(){ if(!actx) actx=new AC(); return actx; }
function tone(type,f,ms,g=.07){ if(!SOUND) return; const a=ctx(),o=a.createOscillator(),v=a.createGain();o.type=type;o.frequency.value=f;v.gain.value=g;o.connect(v);v.connect(a.destination);const t=a.currentTime;o.start(t);o.stop(t+ms/1000)}
function clickLock(){tone('triangle',420,60,.08)}
function fanfare(){tone('triangle',660,160,.09);setTimeout(()=>tone('triangle',880,180,.09),150);setTimeout(()=>tone('square',990,200,.07),320)}

/* === Конфетти (большой взрыв) — только gold/platinum === */
function confettiBig(){
  const canvas=confettiCanvas,ctx=canvas.getContext('2d');
  canvas.width=innerWidth; canvas.height=innerHeight; canvas.style.display='block';
  const colors=['#fff2a0','#ffd86b','#f3c43a','#ff8ec5','#9cffd5','#caa245','#8a6a1f','#ffffff'];
  const N=confettiCap;
  const parts=Array.from({length:N},()=>({x:innerWidth/2+(Math.random()*40-20),y:innerHeight/2+(Math.random()*20-10),r:6+Math.random()*9,vx:-6+Math.random()*12,vy:-10-Math.random()*10,rot:Math.random()*Math.PI,vr:-.25+Math.random()*.5,color:colors[(Math.random()*colors.length)|0],a:1}));
  const g=0.35, t0=performance.now(), D=2200;
  (function tick(t){
    const dt=(t-(tick.t||t))/16.6; tick.t=t; ctx.clearRect(0,0,canvas.width,canvas.height);
    parts.forEach(p=>{
      p.vy+=g*dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.rot+=p.vr*dt; p.a*=0.986;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha=p.a;
      ctx.fillStyle=p.color;
      ctx.beginPath(); const spikes=5, outer=p.r*.7, inner=p.r*.34;
      for(let i=0;i<spikes*2;i++){const ang=i*Math.PI/spikes;const rr=i%2===0?outer:inner;ctx.lineTo(Math.cos(ang)*rr,Math.sin(ang)*rr)}
      ctx.closePath(); ctx.fill(); ctx.restore();
    });
    if(t-t0<D) requestAnimationFrame(tick); else canvas.style.display='none';
  })(t0);
}

/* === Взаимодействие с ключами: бесконечные попытки, каждый клик — купон === */
function openWinModal(prize){
  // Премиальная подача купона
  ticketBox.className = 'ticket '+prize.class+' pop';
  prizeTitle.textContent = 'Ваш купон';
  ticketTitle.textContent = 'Поздравляем — вы выиграли';
  ticketText.textContent = (prize.id==='free') ? 'Бесплатный билет' : prize.label;
  document.body.style.overflow='hidden';
  winModal.classList.add('open');

  // 3 минуты обратный отсчёт
  startCountdown(3*60*1000);

  // Эффекты
  chest.classList.add('open');
  clickLock();
  if(prize.id==='p50' || prize.id==='free'){ fanfare(); confettiBig(); }
}

function keyClick(e){
  const btn=e.target.closest('.key'); if(!btn) return;
  const prize = choosePrize();
  openWinModal(prize);
  window._lastPrize = prize; // для формы
}
keysWrap.addEventListener('click', keyClick);

/* === Таймер 3 минуты === */
const countdownEl = document.getElementById('countdown'); let countdownTimer; let countdownUntil=0; let couponLocked=false;
function startCountdown(ms){
  clearInterval(countdownTimer);
  couponLocked=false;
  countdownUntil = Date.now()+ms;
  function tick(){
    const left = Math.max(0, countdownUntil - Date.now());
    const m = Math.floor(left/60_000), s = Math.floor((left%60_000)/1000);
    countdownEl.textContent = String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    if(left===0){ clearInterval(countdownTimer); couponLocked=true; }
  }
  tick(); countdownTimer = setInterval(tick, 250);
}

/* === Модалки: открыть форму и закрытия === */
function closeModal(node){ node.classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal__bg').forEach(bg=>{
  bg.addEventListener('click', (e)=>{
    const modal = e.currentTarget.closest('.modal');
    closeModal(modal);
  });
});
document.getElementById('getCoupon').addEventListener('click', ()=>{
  if(couponLocked){ alert('Срок активации истёк. Откройте новый купон.'); return; }
  formModal.classList.add('open'); document.body.style.overflow='hidden';
});

/* === Форма -> отправка в личку через /api/send === */
document.getElementById('couponForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(couponLocked){ alert('Срок активации истёк. Откройте новый купон.'); return; }
  const fio = document.getElementById('fio').value.trim();
  const tg  = document.getElementById('username').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const prize = (window._lastPrize?.id==='free') ? 'Бесплатный билет' : (window._lastPrize?.label || '—');

  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ fio, tg, phone, prize })
    });
    const j = await res.json().catch(()=>({ok:false}));
    if(j.ok){
      closeModal(formModal); closeModal(winModal);
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 4200);
    }else{
      alert('Не удалось отправить. Попробуйте ещё раз.');
    }
  }catch(err){
    alert('Сеть недоступна. Попробуйте ещё раз.');
  }
});

/* === Блёстки на фоне (бережно) === */
let sparkleInit=false;
function initSparkle(){
  if(sparkleInit) return; sparkleInit=true;
  const c=document.getElementById('sparkle'),ctx=c.getContext('2d');
  function resize(){c.width=innerWidth;c.height=innerHeight}
  resize(); addEventListener('resize',resize);
  const density = isMobile ? 90 : 140;
  const stars=Array.from({length:density},()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.6+0.5,a:Math.random()*0.6+0.2,tw:Math.random()*0.02+0.01}));
  (function loop(t=0){
    if(document.hidden){requestAnimationFrame(loop);return;}
    ctx.clearRect(0,0,c.width,c.height);
    stars.forEach(s=>{const p=(Math.sin(t*s.tw)+1)/2;ctx.fillStyle=`rgba(255,235,180,${s.a*p})`;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill()});
    requestAnimationFrame(loop);
  })();
}
['click','touchstart','keydown'].forEach(evt=>document.addEventListener(evt,initSparkle,{once:true}));

/* === Звук тумблер === */
function renderSound(){ soundToggle.classList.toggle('on', SOUND); soundToggle.setAttribute('aria-pressed', SOUND?'true':'false'); }
soundToggle.addEventListener('click', ()=>{ SOUND = !SOUND; localStorage.setItem('sg_sound', SOUND?'1':'0'); renderSound(); });
renderSound();
</script>
</body>
</html>
