<!-- ===================== game.html (игра: сундук + ключи + билеты) ===================== -->
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ШОУ «Секрет» — Сундук удачи</title>
<meta name="theme-color" content="#000"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@800;900&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* базовая тема */
:root{
  --ink:#ECF2FF; --muted:#A9B3C3;
  --woodA:#794626; --woodB:#4a2a15; --woodC:#2a160b;
  --goldA:#fff4bf; --goldB:#ffc95a; --goldC:#ab7a22;
  --glass1:rgba(255,255,255,.10); --glass2:rgba(255,255,255,.04);
  --vh:100vh;
}
*,:before,:after{box-sizing:border-box}
html,body{height:100%;margin:0;background:#000;color:var(--ink);
  font:15px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden}
body:before{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
  background:
    radial-gradient(120% 70% at 50% -10%, rgba(255,255,255,.08), transparent 60%),
    radial-gradient(120% 80% at 50% 120%, rgba(255,255,255,.06), transparent 70%),
    #000}
/* макет */
.wrap{min-height:var(--vh);display:grid;grid-template-rows:auto 1fr auto;place-items:center;gap:14px;
  padding:calc(8px + env(safe-area-inset-top)) 12px calc(14px + env(safe-area-inset-bottom))}
header{text-align:center}
h1{margin:0 6px;font-family:Cinzel,serif;font-weight:900;letter-spacing:.04em;
  font-size:clamp(18px,5.5vw,28px)}
.sub{color:#cfd6e4;margin-top:6px;font-size:clamp(12px,3.8vw,14px)}
.stage{display:grid;gap:16px;place-items:center;width:min(1000px,98vw)}
/* сундук */
.chest{width:min(560px,94vw);position:relative;margin-top:6px}
@media (min-width:660px){ .chest{width:min(680px,92vw)} }
.chest .glow{position:absolute;left:6%;right:6%;bottom:34%;height:22%;
  border-radius:18px;filter:blur(18px);
  background:radial-gradient(120% 120% at 50% 100%, rgba(255,230,140,.55), rgba(255,160,40,.35), transparent 65%);
  opacity:0;transition:opacity .35s ease}
.chest.open .glow{opacity:1}
.lid{height:130px;margin:0 10px;border-radius:18px 18px 10px 10px;
  transform-origin:50% 100%;transform:perspective(700px) rotateX(0deg);
  background:
    radial-gradient(120% 100% at 50% -8%, rgba(255,255,255,.20), transparent 60%),
    repeating-linear-gradient(0deg, rgba(0,0,0,.22) 0 3px, transparent 3px 9px),
    linear-gradient(180deg,#945a30,#5a3219 72%,#2a160b);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),
             inset 0 12px 24px rgba(255,255,255,.10),
             inset 0 -12px 24px rgba(0,0,0,.55)}
.chest.open .lid{animation:openLid .6s cubic-bezier(.2,.8,.2,1) forwards}
@keyframes openLid{ to{ transform:perspective(700px) rotateX(-62deg) } }
.band{height:14px;margin:12px 10px;border-radius:9px;
  background:linear-gradient(180deg,var(--goldA),var(--goldB) 60%,var(--goldC));
  box-shadow:inset 0 1px 0 rgba(255,255,255,.6), inset 0 -2px 0 rgba(0,0,0,.35)}
.base{height:150px;margin:0 10px;border-radius:10px 10px 18px 18px;
  background:
    repeating-linear-gradient(0deg, rgba(0,0,0,.25) 0 3px, transparent 3px 9px),
    linear-gradient(180deg,var(--woodA),var(--woodB) 62%,var(--woodC));
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),
             inset 0 16px 28px rgba(255,255,255,.08),
             inset 0 -18px 28px rgba(0,0,0,.55),
             0 28px 60px rgba(0,0,0,.55)}
.lock{position:absolute;left:50%;bottom:92px;transform:translateX(-50%);
  width:78px;height:90px;border-radius:12px;
  background:linear-gradient(180deg,var(--goldA),var(--goldB) 60%,var(--goldC));
  box-shadow:inset 0 1px 0 rgba(255,255,255,.65), inset 0 -2px 0 rgba(0,0,0,.4), 0 16px 40px rgba(0,0,0,.45)}
.lock:before{content:"";position:absolute;left:50%;top:-46px;transform:translateX(-50%);
  width:94px;height:70px;border-radius:36px 36px 0 0;border:9px solid var(--goldB);border-bottom:0;
  background:linear-gradient(180deg,transparent,rgba(0,0,0,.15));
  box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}
.hole{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:20px;height:30px;background:#2b1c05;border-radius:8px 8px 12px 12px;box-shadow:0 0 0 2px rgba(0,0,0,.35) inset}
.hole:after{content:"";position:absolute;left:50%;top:-13px;transform:translateX(-50%);
  width:24px;height:24px;border-radius:50%;background:#2b1c05;box-shadow:0 0 0 2px rgba(0,0,0,.35) inset}
/* подсказки */
.hud{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.pill{display:inline-grid;place-items:center;padding:8px 12px;border-radius:999px;
  font-weight:900;letter-spacing:.02em;font-size:13px;color:#d7dfef;
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 0 0 1px rgba(255,255,255,.08) inset, 0 10px 26px rgba(0,0,0,.35)}
/* ключи */
.keys{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;width:100%;max-width:980px;margin:6px auto}
@media (min-width:600px){ .keys{grid-template-columns:repeat(8,1fr)} }
@media (min-width:900px){ .keys{grid-template-columns:repeat(10,1fr)} }
.key{position:relative;aspect-ratio:2.4/1;display:grid;place-items:center;border-radius:14px;cursor:pointer;border:0;background:transparent;padding:0}
.key:before{content:"";position:absolute;inset:0;border-radius:14px;background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 8px 22px rgba(0,0,0,.35)}
.key svg{position:relative;width:94%;height:auto;filter:drop-shadow(0 6px 10px rgba(0,0,0,.45))}
.key:active{transform:translateY(1px)}
/* билеты + модалка */
.overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:50}
.modal{width:min(92vw,560px);border-radius:20px;padding:16px;border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.25));box-shadow:0 24px 80px rgba(0,0,0,.6)}
.ticket{
  position:relative;border-radius:16px;padding:24px 20px 82px;text-align:center;color:#111;font-weight:900;letter-spacing:.02em;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.55), inset 0 -1px 0 rgba(0,0,0,.35), 0 36px 120px rgba(0,0,0,.35);
  -webkit-mask:
    radial-gradient(16px at left 22px center, transparent 98%, #000 100%) left,
    radial-gradient(16px at right 22px center, transparent 98%, #000 100%) right;
  -webkit-mask-size:51% 100%; -webkit-mask-repeat:no-repeat;
          mask:
    radial-gradient(16px at left 22px center, transparent 98%, #000 100%) left,
    radial-gradient(16px at right 22px center, transparent 98%, #000 100%) right;
  mask-size:51% 100%; mask-repeat:no-repeat;
}
.t-steel{background:linear-gradient(135deg,#cdd4e1,#9aa5bb 55%,#6f788a)}
.t-bronze{background:linear-gradient(135deg,#e9b188,#b8733f 55%,#7d471e)}
.t-silver{background:linear-gradient(135deg,#f7f9fd,#d1d8e7 50%,#aab3c3)}
.t-gold{background:linear-gradient(135deg,#fff2b6,#ffd36b 45%,#e0a522)}
.t-plat{background:linear-gradient(135deg,#fafbff,#d8dcee 45%,#c3c8d8)}
.ticket h3{margin:6px 6px 4px;font-family:Cinzel,serif;font-size:clamp(20px,5.2vw,26px)}
.ticket p{margin:6px 6px;color:#222}
.actions{position:absolute;left:0;right:0;bottom:14px;display:flex;gap:10px;justify-content:center}
.btn{-webkit-appearance:none;appearance:none;border:0;cursor:pointer;border-radius:14px;padding:12px 18px;font-weight:900;letter-spacing:.02em;color:#fff;
  text-shadow:0 1px 0 rgba(0,0,0,.35);
  background:radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.25), transparent 35%),linear-gradient(180deg,#ff597a,#d9193b);
  box-shadow:0 0 0 1px rgba(255,255,255,.12) inset, 0 12px 40px rgba(255,40,77,.35), 0 2px 0 rgba(0,0,0,.35) inset}
form.grid{display:grid;gap:12px}
.field{display:grid;gap:6px}
.input{width:100%;padding:12px 14px;border-radius:12px;color:#eaf0ff;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);outline:none}
.msg{margin-top:6px;text-align:center}
/* конфетти */
canvas.confetti{position:fixed;inset:0;pointer-events:none;z-index:60}
/* dev-панель (?test=1) */
.dev{position:fixed;top:calc(8px + env(safe-area-inset-top));right:calc(8px + env(safe-area-inset-right));
  display:none;gap:6px;align-items:center;background:rgba(255,255,255,.08);backdrop-filter:blur(8px);
  padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);z-index:80}
.dev select,.dev button{background:rgba(0,0,0,.4);color:#fff;border:1px solid rgba(255,255,255,.15);padding:6px 8px;border-radius:8px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ШОУ «Секрет» · Сундук удачи</h1>
      <div class="sub">Выберите ключ — удачный подсветит замок, крышка приоткроется и появится ваш приз</div>
    </header>

    <section class="stage">
      <!-- сундук -->
      <div class="chest" id="chest">
        <div class="lid" id="lid"></div>
        <div class="band"></div>
        <div class="base"></div>
        <div class="band" style="margin-top:10px"></div>
        <div class="lock"><span class="hole"></span></div>
        <div class="glow"></div>
      </div>

      <div class="hud">
        <span class="pill">Попыток: <b>∞</b></span>
        <span class="pill">Ключей: <b>50</b></span>
      </div>

      <!-- сетка ключей -->
      <div id="grid" class="keys" aria-label="Ключи"></div>
    </section>
  </div>

  <!-- dev tools -->
  <div class="dev" id="dev">
    <span style="font-weight:900">Тест-приз:</span>
    <select id="force">
      <option value="">случайный</option>
      <option value="10">10%</option>
      <option value="15">15%</option>
      <option value="20">20%</option>
      <option value="50">50%</option>
      <option value="free">бесплатный билет</option>
    </select>
    <button id="clear">Закрыть билет</button>
  </div>
  <canvas class="confetti" id="confetti"></canvas>

<script>
/* ====== распределение призов (можно крутить веса) ====== */
const PRIZE_WEIGHTS = [
  {type:'10', w:40},{type:'15', w:25},{type:'20', w:20},{type:'50', w:10},{type:'free', w:5}
];
/* ключи */
const grid = document.getElementById('grid');
for(let i=0;i<50;i++){
  const b = document.createElement('button'); b.className='key'; b.innerHTML = svgKey(i);
  b.addEventListener('click',()=>pickKey(b)); grid.appendChild(b);
}
function svgKey(i){
  const id = `g${i}`;
  return `
  <svg viewBox="0 0 220 90" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <linearGradient id="${id}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#FFF3B5"/><stop offset="55%" stop-color="#FFD36B"/><stop offset="100%" stop-color="#A7741D"/>
      </linearGradient>
      <linearGradient id="${id}h" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="rgba(255,255,255,.65)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/>
      </linearGradient>
    </defs>
    <circle cx="44" cy="45" r="30" fill="url(#${id})"/>
    <circle cx="44" cy="45" r="18" fill="rgba(0,0,0,.45)"/>
    <rect x="76" y="40" width="92" height="10" rx="5" fill="url(#${id})"/>
    <rect x="168" y="34" width="22" height="22" rx="5" fill="url(#${id})"/>
    <rect x="188" y="28" width="24" height="12" rx="3" fill="url(#${id})"/>
    <rect x="188" y="50" width="24" height="12" rx="3" fill="url(#${id})"/>
    <rect x="78" y="40" width="88" height="10" rx="5" fill="url(#${id}h)"/>
  </svg>`;
}
/* dev-панель (?test=1) */
const params = new URLSearchParams(location.search);
const dev = document.getElementById('dev'); const forceSel = document.getElementById('force');
if (params.has('test')) dev.style.display = 'flex';
document.getElementById('clear').onclick=()=>{const o=document.querySelector('.overlay'); if(o) o.remove();};
/* логика полёта ключа и открытия сундука */
const chest = document.getElementById('chest');
function weighted(){
  const f = forceSel.value; if (f) return f;
  const total = PRIZE_WEIGHTS.reduce((a,b)=>a+b.w,0); let r = Math.random()*total;
  for(const p of PRIZE_WEIGHTS){ if((r -= p.w) <= 0) return p.type; } return '10';
}
async function pickKey(btn){
  const r = btn.getBoundingClientRect(), f = btn.cloneNode(true),
        L = document.querySelector('.lock').getBoundingClientRect();
  Object.assign(f.style,{position:'fixed',left:r.left+'px',top:r.top+'px',width:r.width+'px',height:r.height+'px',zIndex:30,transformOrigin:'50% 50%'});
  document.body.appendChild(f);
  const dx=L.left+L.width/2-(r.left+r.width/2), dy=L.top+L.height/2-(r.top+r.height/2);
  f.animate([{transform:'translate(0,0) scale(1)'},
             {transform:`translate(${dx*0.6}px,${dy*0.6}px) scale(1.1)`,offset:.7},
             {transform:`translate(${dx}px,${dy}px) scale(.62)`}],
            {duration:720,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>{
              f.remove(); openChest();
            };
  function openChest(){
    document.querySelector('.lock').animate([{filter:'brightness(1.1)'},{filter:'brightness(1.7)'},{filter:'brightness(1.1)'}],{duration:480});
    chest.classList.add('open');
    const prize = weighted();
    setTimeout(()=>{
      showTicket(prize);
      if(prize==='50' || prize==='free') confetti(prize==='free'?520:360);
      setTimeout(()=>chest.classList.remove('open'),900);
    },520);
  }
}
/* билеты (металлические) + форма */
const label = t => t==='10'?'10% скидка':t==='15'?'15% скидка':t==='20'?'20% скидка':t==='50'?'50% скидка':'Бесплатный билет';
const tclass = t => t==='10'?'t-steel':t==='15'?'t-bronze':t==='20'?'t-silver':t==='50'?'t-gold':'t-plat';
function showTicket(t){
  const o=document.createElement('div'); o.className='overlay';
  o.innerHTML=`<div class="modal">
    <div class="ticket ${tclass(t)}">
      <h3>Поздравляем!</h3>
      <p>Вы выиграли: <b>${label(t)}</b></p>
      <div class="actions">
        <button class="btn" id="next">Далее</button>
        <button class="btn" id="close" style="background:linear-gradient(180deg,#7a8b9d,#4e5a6a)">Закрыть</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(o);
  o.querySelector('#close').onclick=()=>o.remove();
  o.querySelector('#next').onclick=()=>showForm(label(t), o);
}
function showForm(prize, o){
  o.innerHTML=`<div class="modal">
    <form class="grid" id="form">
      <h3 style="margin:0;font-family:Cinzel,serif;text-align:center">Получить приз</h3>
      <div class="field"><label>ФИО</label><input class="input" name="fio" placeholder="Имя Фамилия" required></div>
      <div class="field"><label>Юзернейм Telegram</label><input class="input" name="tg" placeholder="@username" required></div>
      <input type="hidden" name="prize" value="${prize}">
      <button class="btn" type="submit">Отправить</button>
      <div class="msg" id="msg"></div>
    </form>
  </div>`;
  const form=o.querySelector('#form'), msg=o.querySelector('#msg');
  form.onsubmit=async e=>{
    e.preventDefault(); msg.textContent='Отправляем…';
    const data=Object.fromEntries(new FormData(form).entries());
    try{
      const res=await fetch('/api/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      if(!res.ok) throw 0;
      msg.textContent='Готово! Мы получили ваши данные.'; form.querySelector('button').disabled=true;
    }catch{ msg.textContent='Готово! (офлайн-режим) Сохраните скрин для подтверждения.'; form.querySelector('button').disabled=true; }
  }
}
/* конфетти на весь экран */
function confetti(n=360){
  const c=document.getElementById('confetti'), x=c.getContext('2d'), d=Math.max(1,devicePixelRatio||1);
  const rs=()=>{c.width=innerWidth*d; c.height=innerHeight*d; x.setTransform(d,0,0,d,0,0)}; rs();
  let a=[]; const colors=['#ffd34d','#ff5f7a','#9ad4ff','#ffeea8','#b1ffb0','#f7a8ff'];
  for(let i=0;i<n;i++) a.push({x:Math.random()*innerWidth,y:-20-Math.random()*innerHeight*.3,r:4+Math.random()*6,c:colors[(Math.random()*colors.length)|0],al:.95,vy:2+Math.random()*3,vx:-1+Math.random()*2,rot:Math.random()*360,vr:-3+Math.random()*6});
  let id; (function tick(){
    x.clearRect(0,0,innerWidth,innerHeight);
    a.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;p.al-=.0032;
      x.save();x.globalAlpha=Math.max(0,p.al);x.translate(p.x,p.y);x.rotate(p.rot*Math.PI/180);
      x.fillStyle=p.c;x.fillRect(-p.r,-p.r/2,p.r*2,p.r);x.restore();});
    a=a.filter(p=>p.al>0 && p.y<innerHeight+40);
    if(a.length) id=requestAnimationFrame(tick); else cancelAnimationFrame(id);
  })();
  addEventListener('resize', rs, {once:true});
}
/* 100vh фиксер */
function setVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight + 'px'); }
setVH(); addEventListener('resize', setVH);
</script>
</body>
</html>
